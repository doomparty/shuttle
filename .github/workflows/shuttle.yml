name: Auto Deploy to Shuttle with Telegram Notification

on:
  schedule:
    - cron: '0 0 */25 * *'  # 每 25 天的 00:00 UTC 运行
  workflow_dispatch:         # 支持手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Shuttle
        id: shuttle_deploy
        uses: shuttle-hq/deploy-action@v2
        with:
          shuttle-api-key: ${{ secrets.SHUTTLE_API_KEY }}
          # 如果你的 Shuttle 项目需要特定的项目 ID，请取消注释并替换
          # project-id: your_shuttle_project_id

      - name: Send Success Notification to Telegram
        if: steps.shuttle_deploy.outcome == 'success'
        uses: appleboy/telegram-action@v3
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            🚀 Shuttle 部署成功! ✅

            项目: ${{ github.repository }}
            分支: ${{ github.ref_name }}
            提交: ${{ github.sha }}
            工作流: ${{ github.workflow }}
            运行 ID: ${{ github.run_id }}
            触发者: ${{ github.actor }}
            时间: ${{ job.started_at }}

            查看运行详情: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Failure Notification to Telegram
        if: steps.shuttle_deploy.outcome == 'failure'
        uses: appleboy/telegram-action@v3
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            🚨 Shuttle 部署失败! ❌

            项目: ${{ github.repository }}
            分支: ${{ github.ref_name }}
            提交: ${{ github.sha }}
            工作流: ${{ github.workflow }}
            运行 ID: ${{ github.run_id }}
            触发者: ${{ github.actor }}
            时间: ${{ job.started_at }}

            错误信息:
            ```
            ${{ steps.shuttle_deploy.outputs.error }}
            ```

            查看运行详情: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
