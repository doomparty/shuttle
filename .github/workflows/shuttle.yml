name: Deploy to Shuttle

on:
  schedule:
    - cron: '0 0 */10 * *'
  workflow_dispatch:
  watch:
    types: started

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install system packages
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y expect tzdata curl jq

      - name: Fetch latest shuttle-runtime version
        id: latest
        run: |
          version=$(curl -s https://crates.io/api/v1/crates/shuttle-runtime | jq -r '.crate.newest_version')
          echo "Latest shuttle-runtime version: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Install cargo-binstall
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

      - name: Install cargo-shuttle with matching version
        run: cargo binstall -y --locked cargo-shuttle@${{ steps.latest.outputs.version }}

      - name: Deploy to Shuttle
        run: shuttle deploy --id proj_01JFV6T4N10AKW1JENPVHPB44C --no-test --allow-dirty
        env:
          SHUTTLE_API_KEY: ${{ secrets.SHUTTLE_API_KEY }}

      - name: Send Success Notification to Telegram
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            ğŸš€ Shuttle éƒ¨ç½²æˆåŠŸ! âœ…
            é¡¹ç›®: ${{ github.repository }}
            è§¦å‘è€…: ${{ github.actor }}
            æ—¶é—´: ${{ github.event.repository.updated_at }}

      - name: Send Failure Notification to Telegram
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TG_CHAT_ID }}
          token: ${{ secrets.TG_BOT_TOKEN }}
          message: |
            âŒ Shuttle éƒ¨ç½²å¤±è´¥!
            é¡¹ç›®: ${{ github.repository }}
            è§¦å‘è€…: ${{ github.actor }}
            æ—¶é—´: ${{ github.event.repository.updated_at }}
